<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>NEAR</title>
</head>
<body>
  <h1>Welcome to NEAR</h1>
  <p id="status">Initializing...</p>
  <p id="user"></p>

  <h2>Nearby users (within 5 km)</h2>
  <ul id="nearby"></ul>

  <button id="logout">Logout</button>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, collection, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA2ApGkST41s9U53GQIatv4FL8aCPVzeAM",
      authDomain: "near-c7681.firebaseapp.com",
      projectId: "near-c7681",
      storageBucket: "near-c7681.firebasestorage.app",
      messagingSenderId: "316318833624",
      appId: "1:316318833624:web:480beb2c1909e23d1cf0ad"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const statusEl = document.getElementById("status");
    const userEl = document.getElementById("user");
    const nearbyEl = document.getElementById("nearby");

    function distanceKm(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a =
        Math.sin(dLat / 2) ** 2 +
        Math.cos(lat1 * Math.PI / 180) *
        Math.cos(lat2 * Math.PI / 180) *
        Math.sin(dLon / 2) ** 2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }

    signInAnonymously(auth);

    onAuthStateChanged(auth, user => {
      if (!user) return;

      userEl.textContent = "Your ID: " + user.uid.slice(0, 6);

      navigator.geolocation.watchPosition(
        async pos => {
          const { latitude, longitude } = pos.coords;
          statusEl.textContent = "Location received ✔";

          await setDoc(doc(db, "users", user.uid), {
            lat: latitude,
            lng: longitude,
            lastSeen: serverTimestamp()
          });

          onSnapshot(collection(db, "users"), snap => {
            nearbyEl.innerHTML = "";

            snap.forEach(d => {
              if (d.id === user.uid) return;
              const data = d.data();
              if (!data.lat) return;

              const dist = distanceKm(latitude, longitude, data.lat, data.lng);
              if (dist <= 5) {
                const li = document.createElement("li");
                li.textContent = `${d.id.slice(0,6)} • ${dist.toFixed(2)} km`;
                nearbyEl.appendChild(li);
              }
            });

            if (!nearbyEl.children.length) {
              nearbyEl.innerHTML = "<li>No nearby users yet</li>";
            }
          });
        },
        err => {
          statusEl.textContent = "Location error";
          console.error(err);
        },
        { enableHighAccuracy: true }
      );
    });

    document.getElementById("logout").onclick = () => auth.signOut();
  </script>
</body>
</html>
