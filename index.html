<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>NEAR</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
body {
  margin: 0;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  background: #0f172a;
  color: #e5e7eb;
}
header {
  padding: 16px;
  background: #020617;
  font-weight: bold;
  text-align: center;
  font-size: 20px;
}
.container { padding: 16px; }
.card {
  background: #020617;
  border-radius: 14px;
  padding: 14px;
  margin-bottom: 12px;
}
ul { list-style: none; padding: 0; margin: 0; }
li {
  padding: 14px;
  border-radius: 12px;
  margin-bottom: 8px;
  background: #020617;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
button {
  padding: 10px 14px;
  border-radius: 12px;
  border: none;
  font-weight: bold;
  background: #2563eb;
  color: white;
}
.small { font-size: 13px; color: #94a3b8; }
.hidden { display: none; }

.chat {
  display: flex;
  flex-direction: column;
  height: calc(100vh - 230px);
  overflow-y: auto;
  margin-bottom: 70px;
}
.bubble {
  max-width: 75%;
  padding: 10px 14px;
  margin-bottom: 8px;
  border-radius: 16px;
}
.me {
  background: #2563eb;
  align-self: flex-end;
  border-bottom-right-radius: 4px;
}
.them {
  background: #1e293b;
  align-self: flex-start;
  border-bottom-left-radius: 4px;
}
.input-bar {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  display: flex;
  gap: 8px;
  padding: 12px;
  background: #020617;
}
input {
  flex: 1;
  padding: 12px;
  border-radius: 12px;
  border: none;
}
</style>
</head>

<body>

<header>NEAR</header>

<div class="container">

  <div class="card">
    <div id="status" class="small">Initializingâ€¦</div>
    <div>
      You:
      <input id="nameInput" placeholder="Your name" />
      <button id="saveName">Save</button>
    </div>
  </div>

  <div id="nearSection" class="card">
    <h3>Nearby (online)</h3>
    <ul id="nearby"></ul>
  </div>

  <div id="chatSection" class="hidden">
    <h3 id="chatTitle"></h3>
    <div id="messages" class="chat"></div>
  </div>

</div>

<div id="inputBar" class="input-bar hidden">
  <input id="messageInput" placeholder="Messageâ€¦" />
  <button id="sendBtn">Send</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import {
  getFirestore, doc, setDoc, getDoc, collection, addDoc,
  onSnapshot, serverTimestamp, query, orderBy
} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

// â±ï¸ ONLINE WINDOW (3 minutes)
const ONLINE_WINDOW_MS = 3 * 60 * 1000;

const firebaseConfig = {
  apiKey: "AIzaSyA2ApGkST41s9U53GQIatv4FL8aCPVzeAM",
  authDomain: "near-c7681.firebaseapp.com",
  projectId: "near-c7681",
  storageBucket: "near-c7681.firebasestorage.app",
  messagingSenderId: "316318833624",
  appId: "1:316318833624:web:480beb2c1909e23d1cf0ad"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const statusEl = document.getElementById("status");
const nameInput = document.getElementById("nameInput");
const saveNameBtn = document.getElementById("saveName");
const nearbyEl = document.getElementById("nearby");
const messagesEl = document.getElementById("messages");
const chatSection = document.getElementById("chatSection");
const nearSection = document.getElementById("nearSection");
const chatTitle = document.getElementById("chatTitle");
const inputBar = document.getElementById("inputBar");
const inputEl = document.getElementById("messageInput");

let me, username, chatId;
let myLat, myLng;

function km(a,b,c,d){
  const R=6371,dl=(c-a)*Math.PI/180,do_=(d-b)*Math.PI/180;
  return R*2*Math.atan2(Math.sqrt(Math.sin(dl/2)**2+
    Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(do_/2)**2),
    Math.sqrt(1-(
      Math.sin(dl/2)**2+
      Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(do_/2)**2
    )));
}

signInAnonymously(auth);

onAuthStateChanged(auth, user => {
  if (!user) return;
  me = user;

  username = localStorage.getItem("name") || "";
  nameInput.value = username;

  navigator.geolocation.watchPosition(async p => {
    myLat = p.coords.latitude;
    myLng = p.coords.longitude;
    statusEl.textContent = "Online âœ”";

    await saveProfile();

    onSnapshot(collection(db,"users"), snap => {
      nearbyEl.innerHTML="";
      const now = Date.now();

      snap.forEach(d=>{
        if(d.id===me.uid) return;
        const u=d.data();
        if(!u.lat || !u.lng || !u.lastSeen) return;

        // ðŸ‘» FILTER OUT OFFLINE USERS
        const age = now - u.lastSeen.toMillis();
        if(age > ONLINE_WINDOW_MS) return;

        if(km(myLat,myLng,u.lat,u.lng)>5) return;

        const li=document.createElement("li");
        li.innerHTML=`<strong>${u.name || "Anonymous"}</strong>`;
        const btn=document.createElement("button");
        btn.textContent="â¤ï¸ Like";
        btn.onclick=()=>likeUser(d.id,u.name);
        li.appendChild(btn);
        nearbyEl.appendChild(li);
      });

      if(!nearbyEl.children.length){
        nearbyEl.innerHTML="<li class='small'>No one online nearby</li>";
      }
    });
  });
});

saveNameBtn.onclick = async () => {
  username = nameInput.value.trim() || "Anonymous";
  localStorage.setItem("name", username);
  await saveProfile();
  alert("Name updated");
};

async function saveProfile(){
  if(!me) return;
  await setDoc(doc(db,"users",me.uid),{
    name: username,
    lat: myLat,
    lng: myLng,
    lastSeen: serverTimestamp()
  },{ merge:true });
}

async function likeUser(otherId, otherName){
  await setDoc(doc(db,"likes",`${me.uid}_${otherId}`),{
    from: me.uid,
    to: otherId,
    created: serverTimestamp()
  });

  const reverse = await getDoc(doc(db,"likes",`${otherId}_${me.uid}`));
  if(reverse.exists()){
    const matchId=[me.uid,otherId].sort().join("_");
    await setDoc(doc(db,"matches",matchId),{
      users:[me.uid,otherId],
      created: serverTimestamp()
    });
    openChat(otherId, otherName);
  } else {
    alert("Liked ðŸ‘ waiting for match");
  }
}

function openChat(otherId, otherName){
  chatId=[me.uid,otherId].sort().join("_");
  chatTitle.textContent=otherName;
  nearSection.classList.add("hidden");
  chatSection.classList.remove("hidden");
  inputBar.classList.remove("hidden");

  const q=query(collection(db,"chats",chatId,"messages"),orderBy("created"));
  onSnapshot(q,s=>{
    messagesEl.innerHTML="";
    s.forEach(d=>{
      const m=d.data();
      const div=document.createElement("div");
      div.className="bubble "+(m.uid===me.uid?"me":"them");
      div.textContent=m.text;
      messagesEl.appendChild(div);
      messagesEl.scrollTop=messagesEl.scrollHeight;
    });
  });
}

document.getElementById("sendBtn").onclick=async()=>{
  if(!inputEl.value) return;
  await addDoc(collection(db,"chats",chatId,"messages"),{
    uid: me.uid,
    text: inputEl.value,
    created: serverTimestamp()
  });
  inputEl.value="";
};
</script>

</body>
</html>
