<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>NEAR</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
</head>
<body>

<h1>Welcome to NEAR</h1>

<p id="status">Initializing...</p>
<p>Your name: <strong id="user"></strong></p>

<h2>Nearby users (within 5 km)</h2>
<ul id="nearby"></ul>

<button id="logout">Logout</button>

<!-- ðŸ”¥ FIREBASE + APP LOGIC -->
<script type="module">
  // Firebase SDKs
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
  import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
  import { getFirestore, doc, setDoc, collection, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

  // ðŸ”¥ YOUR FIREBASE CONFIG
  const firebaseConfig = {
    apiKey: "AIzaSyA2ApGkST41s9U53GQIatv4FL8aCPVzeAM",
    authDomain: "near-c7681.firebaseapp.com",
    projectId: "near-c7681",
    storageBucket: "near-c7681.firebasestorage.app",
    messagingSenderId: "316318833624",
    appId: "1:316318833624:web:480beb2c1909e23d1cf0ad"
  };

  // Init
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const statusEl = document.getElementById("status");
  const userEl = document.getElementById("user");
  const nearbyEl = document.getElementById("nearby");
  const logoutBtn = document.getElementById("logout");

  // ðŸ“ Distance (Haversine)
  function distanceKm(lat1, lon1, lat2, lon2) {
    const R = 6371;
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a =
      Math.sin(dLat / 2) ** 2 +
      Math.cos(lat1 * Math.PI / 180) *
      Math.cos(lat2 * Math.PI / 180) *
      Math.sin(dLon / 2) ** 2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  }

  // ðŸ” Auto sign-in
  signInAnonymously(auth);

  // ðŸ‘¤ Auth state
  onAuthStateChanged(auth, user => {
    if (!user) return;

    // ðŸ‘‹ Username (once)
    let username = localStorage.getItem("near_username");
    if (!username) {
      username = prompt("Choose a username");
      if (!username) username = "Anonymous";
      localStorage.setItem("near_username", username);
    }

    userEl.textContent = username;

    if (!navigator.geolocation) {
      statusEl.textContent = "Geolocation not supported";
      return;
    }

    navigator.geolocation.watchPosition(
      async pos => {
        const { latitude, longitude } = pos.coords;
        statusEl.textContent = "Location received âœ”";

        // ðŸ’¾ Save user
        await setDoc(doc(db, "users", user.uid), {
          name: username,
          lat: latitude,
          lng: longitude,
          lastSeen: serverTimestamp()
        });

        // ðŸ‘€ Listen for nearby users
        onSnapshot(collection(db, "users"), snapshot => {
          nearbyEl.innerHTML = "";

          snapshot.forEach(docSnap => {
            if (docSnap.id === user.uid) return;

            const data = docSnap.data();
            if (!data.lat || !data.lng) return;

            const d = distanceKm(latitude, longitude, data.lat, data.lng);

            if (d <= 5) {
              const li = document.createElement("li");
              li.textContent = `${data.name || "Anonymous"} â€¢ ${d.toFixed(2)} km`;
              nearbyEl.appendChild(li);
            }
          });

          if (!nearbyEl.children.length) {
            nearbyEl.innerHTML = "<li>No nearby users yet</li>";
          }
        });
      },
      err => {
        statusEl.textContent = "Location error";
        console.error(err);
      },
      { enableHighAccuracy: true }
    );
  });

  // ðŸšª Logout
  logoutBtn.onclick = () => {
    signOut(auth);
    localStorage.removeItem("near_username");
    location.reload();
  };
</script>

</body>
</html>
