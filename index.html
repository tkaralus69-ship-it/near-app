<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Near</title>

<style>
body {
  font-family: system-ui, sans-serif;
  background: #0f0f14;
  color: #fff;
  margin: 0;
}

header {
  padding: 12px;
  background: #151520;
  display: flex;
  justify-content: space-between;
}

ul { list-style: none; padding: 0; }

.nearby-user {
  padding: 10px;
  margin: 8px;
  background: #1d1d2b;
  border-radius: 8px;
  display: flex;
  justify-content: space-between;
}

button {
  background: #ff3d81;
  border: none;
  padding: 6px 12px;
  color: white;
  border-radius: 6px;
}

.hidden { display: none; }

#chatSection {
  display: flex;
  flex-direction: column;
  height: 100vh;
}

#messages {
  flex: 1;
  padding: 10px;
  overflow-y: auto;
}

.bubble {
  max-width: 75%;
  padding: 8px;
  margin-bottom: 8px;
  border-radius: 10px;
}

.me {
  background: #ff3d81;
  align-self: flex-end;
}

.them {
  background: #2a2a3d;
}

.time {
  font-size: 11px;
  opacity: 0.6;
  margin-top: 4px;
}

#inputBar {
  display: flex;
  padding: 10px;
  gap: 6px;
  background: #151520;
}

#msg {
  flex: 1;
  padding: 8px;
  border-radius: 6px;
  border: none;
}

#matchOverlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.85);
  display: flex;
  align-items: center;
  justify-content: center;
}

#matchCard {
  background: #1d1d2b;
  padding: 20px;
  border-radius: 12px;
  text-align: center;
}
</style>
</head>

<body>

<header>
  <div id="status">Connectingâ€¦</div>
  <div id="user"></div>
</header>

<section id="nearSection">
  <ul id="nearby"></ul>
</section>

<section id="chatSection" class="hidden">
  <header id="chatTitle"></header>
  <div id="messages"></div>
  <div id="inputBar">
    <input id="msg" placeholder="Messageâ€¦" />
    <button id="send">Send</button>
  </div>
</section>

<div id="matchOverlay" class="hidden">
  <div id="matchCard">
    <h2>âœ¨ Itâ€™s a match</h2>
    <p id="matchName"></p>
    <button id="startChatBtn">Start Chat</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import {
  getFirestore, doc, setDoc, getDoc,
  collection, addDoc, onSnapshot,
  serverTimestamp, query, orderBy
} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

/* ðŸ”¥ Firebase */
const app = initializeApp({
  apiKey: "AIzaSyA2ApGkST41s9U53GQIatv4FL8aCPVzeAM",
  authDomain: "near-c7681.firebaseapp.com",
  projectId: "near-c7681",
  appId: "1:316318833624:web:480beb2c1909e23d1cf0ad"
});

const auth = getAuth(app);
const db = getFirestore(app);

/* UI */
const statusEl = document.getElementById("status");
const userEl = document.getElementById("user");
const nearbyEl = document.getElementById("nearby");
const chatSection = document.getElementById("chatSection");
const nearSection = document.getElementById("nearSection");
const messagesEl = document.getElementById("messages");
const chatTitle = document.getElementById("chatTitle");
const msgEl = document.getElementById("msg");
const matchOverlay = document.getElementById("matchOverlay");
const matchNameEl = document.getElementById("matchName");
const startChatBtn = document.getElementById("startChatBtn");

/* State */
let me, myName, chatId, pendingChat;

/* Utils */
function distanceKm(a,b,c,d){
  const R=6371, dLat=(c-a)*Math.PI/180, dLon=(d-b)*Math.PI/180;
  return R*2*Math.atan2(
    Math.sqrt(Math.sin(dLat/2)**2 +
    Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(dLon/2)**2),
    Math.sqrt(1)
  );
}

function formatTime(ts){
  if(!ts?.toDate) return "";
  return ts.toDate().toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
}

/* Auth */
signInAnonymously(auth);
onAuthStateChanged(auth, user=>{
  me=user;
  myName=localStorage.name ||= "User-"+Math.random().toString(36).slice(2,6);
  userEl.textContent=myName;

  navigator.geolocation.watchPosition(async pos=>{
    const {latitude, longitude}=pos.coords;
    statusEl.textContent="Online âœ”";

    await setDoc(doc(db,"users",me.uid),{
      name:myName, lat:latitude, lng:longitude, lastSeen:serverTimestamp()
    });

    onSnapshot(collection(db,"users"), snap=>{
      nearbyEl.innerHTML="";
      snap.forEach(d=>{
        if(d.id===me.uid) return;
        const u=d.data();
        if(distanceKm(latitude,longitude,u.lat,u.lng)<=5){
          const li=document.createElement("li");
          li.className="nearby-user";
          li.innerHTML=`<strong>${u.name}</strong>`;
          const b=document.createElement("button");
          b.textContent="Like";
          b.onclick=()=>likeUser(d.id,u.name);
          li.appendChild(b);
          nearbyEl.appendChild(li);
        }
      });
    });
  });
});

/* â¤ï¸ Likes */
async function likeUser(uid,name){
  await setDoc(doc(db,"likes",me.uid+"_"+uid),{from:me.uid,to:uid});
  const rev=await getDoc(doc(db,"likes",uid+"_"+me.uid));
  if(rev.exists()){
    pendingChat={uid,name};
    matchNameEl.textContent=`You and ${name}`;
    matchOverlay.classList.remove("hidden");
  } else alert("Liked ðŸ‘");
}

startChatBtn.onclick=()=>{
  matchOverlay.classList.add("hidden");
  openChat(me.uid,pendingChat.uid,pendingChat.name);
};

/* ðŸ’¬ Chat */
function openChat(a,b,name){
  chatId=[a,b].sort().join("_");
  chatTitle.textContent=name;
  nearSection.classList.add("hidden");
  chatSection.classList.remove("hidden");
  messagesEl.innerHTML="";

  const q=query(collection(db,"chats",chatId,"messages"),orderBy("created"));
  onSnapshot(q,s=>{
    messagesEl.innerHTML="";
    s.forEach(d=>{
      const m=d.data();
      const div=document.createElement("div");
      div.className="bubble "+(m.uid===me.uid?"me":"them");

      const text=document.createElement("div");
      text.textContent=m.text;
      div.appendChild(text);

      const time=document.createElement("div");
      time.className="time";
      time.textContent=formatTime(m.created);
      div.appendChild(time);

      messagesEl.appendChild(div);
    });
    messagesEl.scrollTop=messagesEl.scrollHeight;
  });
}

document.getElementById("send").onclick=async()=>{
  if(!chatId || !msgEl.value) return;
  await addDoc(collection(db,"chats",chatId,"messages"),{
    uid:me.uid, text:msgEl.value, created:serverTimestamp()
  });
  msgEl.value="";
};
</script>
</body>
</html>
