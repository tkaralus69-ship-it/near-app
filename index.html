<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NEAR</title>
  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f1a2f;
      --panel2:#0b1326;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --line:rgba(255,255,255,.08);
      --accent:#60a5fa;
      --good:#34d399;
      --warn:#fbbf24;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:linear-gradient(180deg,#070b14 0%, #0b1220 40%, #070b14 100%);
      color:var(--text);
    }
    header{
      position:sticky; top:0;
      z-index:10;
      background:rgba(5,8,15,.85);
      backdrop-filter: blur(8px);
      border-bottom:1px solid var(--line);
      padding:14px 16px;
      display:flex; align-items:center; justify-content:space-between;
    }
    header .brand{
      font-weight:800;
      letter-spacing:.12em;
      font-size:16px;
    }
    header .sub{
      font-size:12px;
      color:var(--muted);
      margin-top:2px;
    }
    .wrap{max-width:860px;margin:0 auto;padding:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .panel{
      background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius:16px;
      padding:14px;
      box-shadow:0 10px 30px rgba(0,0,0,.25);
    }
    .panel h3{margin:0 0 10px 0;font-size:14px;color:#dbeafe}
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      background:rgba(255,255,255,.04);
      border:1px solid var(--line);
      font-size:12px;
      color:var(--muted);
      margin-right:8px;
      margin-bottom:8px;
      user-select:none;
    }
    .btn{
      appearance:none;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      font-weight:650;
      font-size:14px;
      cursor:pointer;
    }
    .btn.primary{
      background:rgba(96,165,250,.18);
      border-color:rgba(96,165,250,.35);
    }
    .btn.good{
      background:rgba(52,211,153,.18);
      border-color:rgba(52,211,153,.35);
    }
    .btn:active{transform:translateY(1px)}
    .btn.vibe.active{
      outline:2px solid rgba(96,165,250,.55);
      border-color:rgba(96,165,250,.55);
    }
    .smallMuted{font-size:12px;color:var(--muted)}
    .cards{display:flex;flex-direction:column;gap:10px}
    .card{
      display:grid;
      grid-template-columns:52px 1fr auto;
      gap:12px;
      align-items:center;
      padding:12px;
      border-radius:16px;
      background:rgba(5,8,15,.35);
      border:1px solid var(--line);
    }
    .avatar{
      width:52px;height:52px;border-radius:14px;
      object-fit:cover;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
    }
    .name{margin:0;font-weight:750}
    .bio{margin:4px 0 0 0;color:var(--muted);font-size:13px;line-height:1.35}
    .town{margin-top:6px;font-size:11px;letter-spacing:.12em;color:#cbd5e1}
    .right{font-size:12px;color:#cbd5e1;white-space:nowrap}

    /* Overlay */
    .overlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.6);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding:14px;
      z-index:50;
    }
    .overlay.show{display:flex}
    .sheet{
      width:100%;
      max-width:720px;
      border-radius:20px;
      background:linear-gradient(180deg,rgba(15,26,47,.98),rgba(11,19,38,.98));
      border:1px solid var(--line);
      box-shadow:0 20px 60px rgba(0,0,0,.5);
      overflow:hidden;
    }
    .sheetHead{
      padding:14px 16px;
      border-bottom:1px solid var(--line);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .sheetHead .title{
      font-weight:800;
      font-size:14px;
    }
    .sheetHead .subtitle{
      font-size:12px;color:var(--muted);margin-top:2px;
    }
    .sheetBody{padding:14px 16px;display:grid;gap:12px}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input, textarea{
      width:100%;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--text);
      padding:12px;
      font-size:14px;
      outline:none;
    }
    textarea{min-height:92px;resize:vertical}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:560px){.grid2{grid-template-columns:1fr}}
    .previewRow{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .previewRow img{
      width:72px;height:72px;border-radius:18px;object-fit:cover;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
    }
    .sheetFoot{
      padding:14px 16px;
      border-top:1px solid var(--line);
      display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;
    }
  </style>
</head>

<body>
  <header>
    <div>
      <div class="brand">NEAR</div>
      <div class="sub">nearest & dearest — closer than you think</div>
    </div>
    <div class="pill" id="pillStatus">Up to date</div>
  </header>

  <div class="wrap">
    <div class="row">
      <div class="panel" style="flex:1;min-width:280px">
        <h3>Status</h3>
        <div class="pill" id="authStatus">Auth: ...</div>
        <div class="pill" id="locStatus">Location: ...</div>
        <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn primary" id="btnRequestLocation">Request location</button>
          <button class="btn good" id="btnCreate">Create</button>
          <button class="btn" id="btnMe">Me</button>
        </div>

        <div style="margin-top:12px">
          <div class="smallMuted" style="margin-bottom:8px">Pick a vibe</div>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn vibe" data-vibe="Chill">Chill</button>
            <button class="btn vibe" data-vibe="Adventure">Adventure</button>
            <button class="btn vibe" data-vibe="Coffee">Coffee</button>
            <button class="btn vibe" data-vibe="Beach">Beach</button>
            <button class="btn vibe" data-vibe="Night">Night</button>
          </div>
        </div>
      </div>

      <div class="panel" style="flex:1.1;min-width:280px">
        <h3>Nearby</h3>
        <div class="pill" id="nearCount">0 nearby</div>
        <div class="cards" id="peopleList" style="margin-top:10px">
          <div class="smallMuted">No nearby users yet</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Profile Overlay -->
  <div class="overlay" id="profileOverlay" aria-hidden="true">
    <div class="sheet" role="dialog" aria-modal="true">
      <div class="sheetHead">
        <div>
          <div class="title" id="profileSubtitle">Profile</div>
          <div class="subtitle" id="profileHint">Create starts blank every time. Save publishes a new profile.</div>
        </div>
        <button class="btn" id="btnBack">Close</button>
      </div>

      <div class="sheetBody">
        <div class="grid2">
          <div>
            <label>Name</label>
            <input id="nameInput" placeholder="Your name"/>
          </div>
          <div>
            <label>Age</label>
            <input id="ageInput" inputmode="numeric" placeholder="18+" />
          </div>
        </div>

        <div>
          <label>Short bio (10+ chars)</label>
          <textarea id="bioInput" placeholder="A little about you..."></textarea>
        </div>

        <div class="grid2">
          <div>
            <label>Town</label>
            <input id="townInput" placeholder="Town / suburb"/>
          </div>
          <div>
            <label>Photo URL (optional)</label>
            <input id="photoInput" placeholder="https://..." />
          </div>
        </div>

        <div class="panel" style="padding:12px;border-radius:16px">
          <div class="smallMuted" style="margin-bottom:8px">Or upload a photo (goes to Storage)</div>
          <div class="previewRow">
            <img id="photoPreview" src="" alt="" />
            <div style="flex:1;min-width:220px">
              <input id="photoFile" type="file" accept="image/*"/>
              <div class="smallMuted" style="margin-top:6px">
                Upload path: <code style="color:#cbd5e1">users/&lt;uid&gt;/profile_*.jpg</code>
              </div>
            </div>
          </div>
        </div>

      </div>

      <div class="sheetFoot">
        <button class="btn" id="btnCancel">Cancel</button>
        <button class="btn good" id="btnSave">Update profile</button>
      </div>
    </div>
  </div>

  <script type="module">
    // NEAR — fundamentals build
    // Create = blank form EVERY time
    // Me = load your latest saved profile
    // Nearby = profiles within 5 km (client-side distance)
    // Storage upload = optional image file -> photoURL saved

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      getFirestore,
      collection,
      addDoc,
      getDocs,
      query,
      where,
      orderBy,
      limit,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
    import {
      getStorage,
      ref as sRef,
      uploadBytes,
      getDownloadURL
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js";

    // ✅ Your Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyA2ApGkST41s9U53GQIatv4FL8aCPVzeAM",
      authDomain: "near-c7681.firebaseapp.com",
      projectId: "near-c7681",
      // IMPORTANT: use your actual bucket shown in Firebase > Storage
      storageBucket: "near-acf1c.firebasestorage.app",
      messagingSenderId: "316318833624",
      appId: "1:316318833624:web:480beb2c1909e23d1cf0ad",
      measurementId: "G-98XYEKXLLT"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    console.log("Firebase init OK:", firebaseConfig.projectId);

    // ---------------------------
    // UI elements
    // ---------------------------
    const authStatusEl = document.getElementById("authStatus");
    const locStatusEl  = document.getElementById("locStatus");
    const pillStatusEl = document.getElementById("pillStatus");

    const peopleListEl = document.getElementById("peopleList");
    const nearCountEl  = document.getElementById("nearCount");

    const btnRequestLocation = document.getElementById("btnRequestLocation");
    const btnCreate = document.getElementById("btnCreate");
    const btnMe = document.getElementById("btnMe");

    const profileOverlay = document.getElementById("profileOverlay");
    const profileSubtitle = document.getElementById("profileSubtitle");
    const profileHint = document.getElementById("profileHint");

    const nameInput = document.getElementById("nameInput");
    const ageInput = document.getElementById("ageInput");
    const bioInput = document.getElementById("bioInput");
    const townInput = document.getElementById("townInput");
    const photoInput = document.getElementById("photoInput");
    const photoPreview = document.getElementById("photoPreview");
    const photoFile = document.getElementById("photoFile");

    const btnBack = document.getElementById("btnBack");
    const btnCancel = document.getElementById("btnCancel");
    const btnSave = document.getElementById("btnSave");

    // vibe buttons
    let selectedVibe = null;
    document.querySelectorAll(".btn.vibe").forEach((btn) => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".btn.vibe").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        const vibe = btn.dataset.vibe || null;
        pillStatusEl.textContent = vibe ? `Vibe: ${vibe}` : "Up to date";
        selectedVibe = vibe;
      });
    });

    // ---------------------------
    // App state
    // ---------------------------
    let currentUser = null;
    let myLat = null;
    let myLng = null;

    // ---------------------------
    // Helpers
    // ---------------------------
    function showOverlay() {
      profileOverlay.classList.add("show");
      profileOverlay.setAttribute("aria-hidden", "false");
    }
    function hideOverlay() {
      profileOverlay.classList.remove("show");
      profileOverlay.setAttribute("aria-hidden", "true");
    }
    function setLocationStatus(text) {
      locStatusEl.textContent = `Location: ${text}`;
    }
    function setAuthStatus(text) {
      authStatusEl.textContent = `Auth: ${text}`;
    }
    function clamp(n, min, max) {
      return Math.max(min, Math.min(max, n));
    }
    function distanceKm(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const toRad = (d) => (d * Math.PI) / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a =
        Math.sin(dLat / 2) ** 2 +
        Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
        Math.sin(dLon / 2) ** 2;
      return 2 * R * Math.asin(Math.sqrt(a));
    }
    function safeMinDistanceKm(km) {
      return Math.max(1, km); // privacy minimum
    }
    function escapeHtml(s) {
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function clearProfileForm() {
      nameInput.value = "";
      ageInput.value = "";
      bioInput.value = "";
      townInput.value = "";
      photoInput.value = "";
      photoPreview.src = "";
      photoFile.value = "";
    }
    function fillProfileForm(data) {
      nameInput.value = data?.name || "";
      ageInput.value = (data?.age ?? "") === null ? "" : (data?.age ?? "");
      bioInput.value = data?.bio || "";
      townInput.value = data?.town || "";
      photoInput.value = data?.photoURL || "";
      photoPreview.src = data?.photoURL || "";
      // do not auto-fill file input (browser blocks it)
      photoFile.value = "";
    }

    function getProfilePayload(photoURLFinal) {
      const name = (nameInput.value || "").trim();
      const age = ageInput.value ? Number(ageInput.value) : null;
      const bio = (bioInput.value || "").trim();
      const town = (townInput.value || "").trim();

      return {
        ownerUid: currentUser?.uid || null,
        name: name || "Anonymous",
        age: age ? clamp(age, 18, 99) : null,
        bio: bio || "",
        town: town || "",
        photoURL: (photoURLFinal || "").trim(),
        vibe: selectedVibe || null,
        lat: myLat,
        lng: myLng,
        updatedAt: serverTimestamp(),
      };
    }

    function renderPeople(people) {
      peopleListEl.innerHTML = "";

      if (!people.length) {
        peopleListEl.innerHTML = `<div class="smallMuted">No nearby users yet</div>`;
        nearCountEl.textContent = "0 nearby";
        return;
      }

      nearCountEl.textContent = `${people.length} nearby`;

      for (const p of people) {
        const km = safeMinDistanceKm(p.distanceKm);
        const kmText = `${km.toFixed(2)} km away`;

        const img = p.photoURL || "";
        const name = `${p.name || "Anonymous"}${p.age ? `, ${p.age}` : ""}`;
        const bio = p.bio || "";
        const town = p.town ? p.town.toUpperCase() : "";

        const el = document.createElement("div");
        el.className = "card";
        el.innerHTML = `
          <img class="avatar" src="${escapeHtml(img)}" alt="" onerror="this.style.display='none'"/>
          <div>
            <p class="name">${escapeHtml(name)}</p>
            <p class="bio">${escapeHtml(bio)}</p>
            <div class="town">${escapeHtml(town)}</div>
          </div>
          <div class="right">${escapeHtml(kmText)}</div>
        `;
        peopleListEl.appendChild(el);
      }
    }

    // ---------------------------
    // Location
    // ---------------------------
    function requestLocationOnce() {
      if (!navigator.geolocation) {
        setLocationStatus("not supported");
        return;
      }
      setLocationStatus("requesting…");

      navigator.geolocation.getCurrentPosition(
        (pos) => {
          myLat = pos.coords.latitude;
          myLng = pos.coords.longitude;
          setLocationStatus("acquired ✅");
          refreshNearby();
        },
        () => {
          setLocationStatus("blocked / denied");
        },
        { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
      );
    }

    btnRequestLocation.addEventListener("click", requestLocationOnce);

    // ---------------------------
    // Auth + boot
    // ---------------------------
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        setAuthStatus("signing in…");
        try {
          await signInAnonymously(auth);
          return;
        } catch (e) {
          console.error(e);
          setAuthStatus("sign-in failed");
          return;
        }
      }

      currentUser = user;
      setAuthStatus("signed in ✅");
      requestLocationOnce();
      refreshNearby();
      setInterval(refreshNearby, 8000);
    });

    // ---------------------------
    // Profile overlay logic
    // ---------------------------
    btnCreate.addEventListener("click", () => {
      clearProfileForm();
      profileSubtitle.textContent = "Profile";
      profileHint.textContent = "Create starts blank every time. Save publishes a new profile.";
      btnSave.textContent = "Update profile";
      showOverlay();
    });

    btnMe.addEventListener("click", async () => {
      clearProfileForm();
      profileSubtitle.textContent = "Profile";
      profileHint.textContent = "Me loads your latest saved profile.";

      try {
        const q = query(
          collection(db, "profiles"),
          where("ownerUid", "==", currentUser.uid),
          orderBy("updatedAt", "desc"),
          limit(1)
        );
        const snap = await getDocs(q);

        if (snap.empty) {
          profileHint.textContent = "No saved profile yet. Use Create to make one.";
        } else {
          fillProfileForm(snap.docs[0].data());
        }
      } catch (e) {
        console.error(e);
        profileHint.textContent = "Could not load your profile (Firestore rules / index).";
      }

      btnSave.textContent = "Update profile";
      showOverlay();
    });

    btnBack.addEventListener("click", hideOverlay);
    btnCancel.addEventListener("click", hideOverlay);

    // photo preview (URL)
    photoInput.addEventListener("input", () => {
      const url = (photoInput.value || "").trim();
      photoPreview.src = url || "";
    });

    // photo preview (FILE) — shows preview instantly
    photoFile.addEventListener("change", () => {
      const f = photoFile.files && photoFile.files[0];
      if (!f) return;
      const objUrl = URL.createObjectURL(f);
      photoPreview.src = objUrl;
      // do not set photoInput here; we’ll set photoURL after upload
    });

    async function uploadPhotoIfNeeded() {
      const f = photoFile.files && photoFile.files[0];
      if (!f) {
        // no file chosen, use URL field (if any)
        return (photoInput.value || "").trim();
      }
      if (!currentUser) throw new Error("No auth user");
      const ext = (f.name.split(".").pop() || "jpg").toLowerCase();
      const safeExt = ["jpg","jpeg","png","webp"].includes(ext) ? ext : "jpg";
      const path = `users/${currentUser.uid}/profile_${Date.now()}.${safeExt}`;
      const fileRef = sRef(storage, path);

      pillStatusEl.textContent = "Uploading photo…";
      await uploadBytes(fileRef, f, { contentType: f.type || "image/jpeg" });
      const url = await getDownloadURL(fileRef);
      pillStatusEl.textContent = selectedVibe ? `Vibe: ${selectedVibe}` : "Up to date";
      return url;
    }

    btnSave.addEventListener("click", async () => {
      if (!currentUser) return;

      if (myLat == null || myLng == null) {
        alert("Please enable location first.");
        return;
      }

      const bio = (bioInput.value || "").trim();
      if (!bio || bio.length < 10) {
        alert("Bio is too short. Write a little more (10+ characters).");
        return;
      }

      try {
        btnSave.disabled = true;
        btnSave.textContent = "Saving…";

        const photoURLFinal = await uploadPhotoIfNeeded();
        const payload = getProfilePayload(photoURLFinal);

        await addDoc(collection(db, "profiles"), payload);

        hideOverlay();
        refreshNearby();
      } catch (e) {
        console.error(e);
        alert("Save failed. Usually Firestore rules, Storage rules, or bucket mismatch.");
      } finally {
        btnSave.disabled = false;
        btnSave.textContent = "Update profile";
      }
    });

    // ---------------------------
    // Nearby list
    // ---------------------------
    async function refreshNearby() {
      if (!currentUser) return;

      if (myLat == null || myLng == null) {
        nearCountEl.textContent = "Waiting for location…";
        peopleListEl.innerHTML = `<div class="smallMuted">Waiting for location…</div>`;
        return;
      }

      try {
        const snap = await getDocs(collection(db, "profiles"));
        const all = snap.docs.map(d => ({ id: d.id, ...d.data() }));

        // latest profile per ownerUid
        const latestByOwner = new Map();
        for (const p of all) {
          const key = p.ownerUid || p.id;
          const existing = latestByOwner.get(key);
          const pMillis = p.updatedAt?.toMillis ? p.updatedAt.toMillis() : 0;
          const eMillis = existing?.updatedAt?.toMillis ? existing.updatedAt.toMillis() : 0;
          if (!existing || pMillis >= eMillis) latestByOwner.set(key, p);
        }

        const unique = Array.from(latestByOwner.values());

        const near = unique
          .filter(p => typeof p.lat === "number" && typeof p.lng === "number")
          .map(p => ({ ...p, distanceKm: distanceKm(myLat, myLng, p.lat, p.lng) }))
          .filter(p => p.distanceKm <= 5)
          .sort((a,b) => a.distanceKm - b.distanceKm);

        renderPeople(near);
      } catch (e) {
        console.error(e);
        nearCountEl.textContent = "Error loading nearby";
        peopleListEl.innerHTML = `<div class="smallMuted">Could not load nearby (Firestore rules).</div>`;
      }
    }
  </script>
</body>
</html>
