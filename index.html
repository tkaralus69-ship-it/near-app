<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>NEAR</title>

<style>
  body {
    font-family: system-ui, sans-serif;
    margin: 0;
    background: #0f0f14;
    color: #fff;
  }

  header {
    padding: 16px;
    text-align: center;
    font-weight: bold;
    font-size: 20px;
  }

  #status {
    text-align: center;
    opacity: 0.8;
    margin-bottom: 8px;
  }

  #profile {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 16px;
  }

  .avatar {
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: #2a2a33;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    overflow: hidden;
  }

  .avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  #nearby {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .nearby-user {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    border-bottom: 1px solid #222;
  }

  .nearby-user button {
    margin-left: auto;
    background: #ff4d6d;
    border: none;
    padding: 6px 12px;
    border-radius: 12px;
    color: #fff;
    cursor: pointer;
  }

  input[type="file"] {
    display: none;
  }

  label.upload {
    font-size: 12px;
    opacity: 0.7;
    cursor: pointer;
  }
</style>
</head>

<body>

<header>NEAR</header>
<div id="status">Connecting…</div>

<div id="profile">
  <div class="avatar" id="myAvatar">?</div>
  <div>
    <div id="myName"></div>
    <label class="upload">
      Upload photo
      <input type="file" id="photoInput" accept="image/*" />
    </label>
  </div>
</div>

<ul id="nearby"></ul>

<script type="module">
/* Firebase */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import {
  getFirestore,
  doc,
  setDoc,
  collection,
  onSnapshot,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";
import {
  getStorage,
  ref,
  uploadBytes,
  getDownloadURL
} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-storage.js";

/* Config */
const firebaseConfig = {
  apiKey: "AIzaSyA2ApGkST41s9U53GQIatv4FL8aCPVzeAM",
  authDomain: "near-c7681.firebaseapp.com",
  projectId: "near-c7681",
  storageBucket: "near-c7681.appspot.com",
  appId: "1:316318833624:web:480beb2c1909e23d1cf0ad"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

/* UI */
const statusEl = document.getElementById("status");
const nearbyEl = document.getElementById("nearby");
const myAvatar = document.getElementById("myAvatar");
const myNameEl = document.getElementById("myName");
const photoInput = document.getElementById("photoInput");

/* State */
let me;
let myName;
let myPhoto = null;

/* Distance */
function distanceKm(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a =
    Math.sin(dLat / 2) ** 2 +
    Math.cos(lat1 * Math.PI / 180) *
    Math.cos(lat2 * Math.PI / 180) *
    Math.sin(dLon / 2) ** 2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

/* Auth */
signInAnonymously(auth);

onAuthStateChanged(auth, async user => {
  if (!user) return;
  me = user;

  myName = localStorage.getItem("name") ||
    "User-" + Math.random().toString(36).slice(2, 6);
  localStorage.setItem("name", myName);
  myNameEl.textContent = myName;
  myAvatar.textContent = myName[0];

  navigator.geolocation.watchPosition(async pos => {
    const { latitude, longitude } = pos.coords;
    statusEl.textContent = "Online ✔";

    await setDoc(doc(db, "users", me.uid), {
      name: myName,
      photo: myPhoto || null,
      lat: latitude,
      lng: longitude,
      lastSeen: serverTimestamp()
    }, { merge: true });

    onSnapshot(collection(db, "users"), snap => {
      nearbyEl.innerHTML = "";

      snap.forEach(d => {
        if (d.id === me.uid) return;
        const u = d.data();
        if (!u.lat) return;

        const km = distanceKm(latitude, longitude, u.lat, u.lng);
        if (km > 5) return;

        const li = document.createElement("li");
        li.className = "nearby-user";

        const av = document.createElement("div");
        av.className = "avatar";
        if (u.photo) {
          av.innerHTML = `<img src="${u.photo}" />`;
        } else {
          av.textContent = u.name?.[0] || "?";
        }

        const name = document.createElement("strong");
        name.textContent = u.name;

        const btn = document.createElement("button");
        btn.textContent = "Like";

        li.append(av, name, btn);
        nearbyEl.appendChild(li);
      });

      if (!nearbyEl.children.length) {
        nearbyEl.innerHTML = "<li style='padding:16px;opacity:.6'>No nearby users</li>";
      }
    });
  });
});

/* Photo upload */
photoInput.onchange = async e => {
  const file = e.target.files[0];
  if (!file) return;

  const r = ref(storage, `avatars/${me.uid}`);
  await uploadBytes(r, file);
  myPhoto = await getDownloadURL(r);

  myAvatar.innerHTML = `<img src="${myPhoto}" />`;

  await setDoc(doc(db, "users", me.uid), {
    photo: myPhoto
  }, { merge: true });
};
</script>

</body>
</html>
