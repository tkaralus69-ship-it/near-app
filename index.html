<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Near</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
:root{
  --bg1:#12182e;
  --bg2:#070b18;
  --card:rgba(255,255,255,0.06);
  --accent:#1ea7ff;
  --muted:#9aa3c7;
}

*{box-sizing:border-box;font-family:system-ui,sans-serif}

body{
  margin:0;
  background:radial-gradient(circle at top,var(--bg1),var(--bg2));
  color:#fff;
}

header{
  padding:32px 20px 12px;
  text-align:center;
}
header h1{margin:0;font-size:36px}
header p{margin:6px 0;color:var(--muted)}
#count{font-size:14px;opacity:.8}

#list{
  max-width:520px;
  margin:0 auto;
  padding:16px 16px 160px;
}

.card{
  display:flex;
  gap:14px;
  padding:16px;
  margin-bottom:14px;
  background:var(--card);
  border-radius:18px;
  backdrop-filter:blur(10px);
  transition:.3s ease;
}
.card.me{outline:2px solid var(--accent)}

.avatar{
  width:54px;height:54px;border-radius:50%;
  background:linear-gradient(135deg,#2d3b6a,#1b2445);
}

.info{flex:1}
.name{font-size:18px;font-weight:600}
.now,.distance{font-size:14px;color:var(--muted);margin-top:4px}

footer{
  position:fixed;left:0;right:0;bottom:0;
  padding:16px;
  background:linear-gradient(to top,rgba(7,11,24,.95),rgba(7,11,24,.6));
}
button{
  width:100%;max-width:520px;margin:0 auto;
  display:block;padding:16px;
  font-size:18px;border-radius:14px;
  border:none;font-weight:700;
  background:var(--accent);color:#000;
}

/* HELLO MODAL */
.modal{
  position:fixed;inset:0;
  background:rgba(0,0,0,.65);
  display:none;align-items:center;justify-content:center;
}
.modal.open{display:flex}
.modal-card{
  background:#0b1022;
  border-radius:20px;
  padding:20px;
  width:90%;max-width:420px;
}
textarea{
  width:100%;min-height:90px;
  border-radius:14px;border:none;
  padding:12px;font-size:16px;
  background:#1b2140;color:#fff;
  resize:none;
}
.modal-card button{margin-top:12px}

/* PROFILE SHEET */
.sheet{
  position:fixed;left:0;right:0;bottom:-100%;
  background:#0b1022;
  border-radius:22px 22px 0 0;
  padding:20px;
  transition:.35s ease;
}
.sheet.open{bottom:0}
.sheet input{
  width:100%;padding:14px;margin-bottom:12px;
  border-radius:12px;border:none;
}
.sheet small{color:var(--muted)}
</style>
</head>

<body>

<header>
  <h1>Near</h1>
  <p>Real people. Near you.</p>
  <div id="count">Finding people…</div>
</header>

<div id="list"></div>

<footer>
  <button onclick="openHello()">Say hello (1 message)</button>
</footer>

<!-- HELLO -->
<div class="modal" id="helloModal">
  <div class="modal-card">
    <h3>Say hello</h3>
    <textarea id="helloText" maxlength="240"
      placeholder="One message. Kind. Real."></textarea>
    <button onclick="sendHello()">Send</button>
  </div>
</div>

<!-- PROFILE -->
<div class="sheet" id="profileSheet">
  <h2>Your presence</h2>
  <input id="pName" placeholder="Name (optional)" />
  <input id="pAge" placeholder="Age range (eg 30s)" />
  <input id="pNow" placeholder="Right now I'm…" />
  <button onclick="saveProfile()">Save</button>
  <small>Nothing here is permanent.</small>
</div>

<script type="module">
/* ========= STATE ========= */
const list = document.getElementById("list");
const count = document.getElementById("count");
const helloModal = document.getElementById("helloModal");
const ACTIVE_MS = 45_000;

let myUid=null,myLat=null,myLng=null;
let profile=JSON.parse(localStorage.getItem("nearProfile")||"{}");

/* ========= HELPERS ========= */
const R=6371;
const km=(a,b,c,d)=>{
  const dLat=(c-a)*Math.PI/180;
  const dLng=(d-b)*Math.PI/180;
  const x=Math.sin(dLat/2)**2+
    Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*
    Math.sin(dLng/2)**2;
  return R*(2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x)));
};

/* ========= UI ========= */
function renderMe(){
  const c=document.createElement("div");
  c.className="card me";
  c.innerHTML=`
    <div class="avatar"></div>
    <div class="info">
      <div class="name">${profile.name||"You"} ${profile.age||""}</div>
      <div class="now">${profile.now||"Tap & hold to edit presence"}</div>
    </div>`;
  c.oncontextmenu=e=>{e.preventDefault();openProfile();}
  list.appendChild(c);
}

window.openHello=()=>helloModal.classList.add("open");
helloModal.onclick=e=>{
  if(e.target===helloModal)helloModal.classList.remove("open");
};
window.sendHello=()=>{
  helloModal.innerHTML=`
    <div class="modal-card">
      <h3>Sent</h3>
      <p style="opacity:.7">
        If it’s meant, you’ll hear back.<br><br>
        Go live your life.
      </p>
    </div>`;
};

/* ========= PROFILE ========= */
function openProfile(){
  profileSheet.classList.add("open");
  pName.value=profile.name||"";
  pAge.value=profile.age||"";
  pNow.value=profile.now||"";
}
window.saveProfile=()=>{
  profile={
    name:pName.value.trim(),
    age:pAge.value.trim(),
    now:pNow.value.trim()
  };
  localStorage.setItem("nearProfile",JSON.stringify(profile));
  profileSheet.classList.remove("open");
  updateFirestore();
};

/* ========= FIREBASE ========= */
import{initializeApp}from"https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
import{getAuth,signInAnonymously}from"https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
import{getFirestore,doc,setDoc,onSnapshot,collection}
from"https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

const firebaseConfig={
  apiKey:"YOUR_KEY",
  authDomain:"YOUR_DOMAIN",
  projectId:"YOUR_ID",
  appId:"YOUR_APP"
};

const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getFirestore(app);

signInAnonymously(auth).then(c=>{
  myUid=c.user.uid;
  navigator.geolocation.watchPosition(p=>{
    myLat=p.coords.latitude;
    myLng=p.coords.longitude;
    updateFirestore();
  });
  listen();
});

function updateFirestore(){
  if(!myUid||myLat==null)return;
  setDoc(doc(db,"users",myUid),{
    ...profile,lat:myLat,lng:myLng,updatedAt:Date.now()
  },{merge:true});
}

/* ========= LIVE LIST ========= */
function listen(){
  onSnapshot(collection(db,"users"),snap=>{
    list.innerHTML="";
    renderMe();
    let visible=0,now=Date.now();

    snap.forEach(d=>{
      if(d.id===myUid)return;
      const u=d.data();
      if(!u.lat||now-u.updatedAt>ACTIVE_MS)return;

      const dist=km(myLat,myLng,u.lat,u.lng);
      if(dist>5)return;

      visible++;
      const c=document.createElement("div");
      c.className="card";
      c.innerHTML=`
        <div class="avatar"></div>
        <div class="info">
          <div class="name">${u.name||"Someone"} ${u.age||""}</div>
          <div class="distance">${Math.round(dist*1000)}m away</div>
          <div class="now">${u.now||""}</div>
        </div>`;
      list.appendChild(c);
    });

    count.textContent=visible
      ? `${visible} people near you`
      : "No one near you right now";
  });
}
</script>
</body>
  </html>
