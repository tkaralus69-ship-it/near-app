<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>NEAR</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
  body {
    margin: 0;
    font-family: system-ui, sans-serif;
    background: #0f172a;
    color: #e5e7eb;
  }
  header {
    padding: 16px;
    background: #020617;
    font-weight: bold;
    text-align: center;
    font-size: 20px;
  }
  .container { padding: 16px; }
  .card {
    background: #020617;
    border-radius: 14px;
    padding: 14px;
    margin-bottom: 12px;
  }
  ul { list-style: none; padding: 0; margin: 0; }
  li {
    padding: 14px;
    border-radius: 12px;
    margin-bottom: 8px;
    background: #020617;
    cursor: pointer;
  }
  .chat {
    display: flex;
    flex-direction: column;
    height: calc(100vh - 240px);
    overflow-y: auto;
    margin-bottom: 70px;
  }
  .bubble {
    max-width: 75%;
    padding: 10px 14px;
    margin-bottom: 8px;
    border-radius: 16px;
  }
  .me { background: #2563eb; align-self: flex-end; }
  .them { background: #1e293b; align-self: flex-start; }
  .input-bar {
    position: fixed;
    bottom: 0; left: 0; right: 0;
    display: flex;
    gap: 8px;
    padding: 12px;
    background: #020617;
  }
  input { flex: 1; padding: 12px; border-radius: 12px; border: none; }
  button {
    padding: 12px 16px;
    border-radius: 12px;
    border: none;
    font-weight: bold;
    background: #2563eb;
    color: white;
  }
  .hidden { display: none; }
  .small { font-size: 13px; color: #94a3b8; }
</style>
</head>

<body>

<header>NEAR</header>

<div class="container">

  <div class="card">
    <div id="status" class="small">Initializingâ€¦</div>
    <div>You are <strong id="user"></strong></div>
  </div>

  <div id="nearSection" class="card">
    <h3>Nearby</h3>
    <ul id="nearby"></ul>
  </div>

  <div id="chatSection" class="hidden">
    <h3 id="chatTitle"></h3>
    <div id="messages" class="chat"></div>
  </div>

</div>

<div id="inputBar" class="input-bar hidden">
  <input id="messageInput" placeholder="Messageâ€¦" />
  <button id="sendBtn">Send</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import {
  getFirestore, doc, setDoc, getDoc, collection, addDoc,
  onSnapshot, serverTimestamp, query, orderBy
} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyA2ApGkST41s9U53GQIatv4FL8aCPVzeAM",
  authDomain: "near-c7681.firebaseapp.com",
  projectId: "near-c7681"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const statusEl = document.getElementById("status");
const userEl = document.getElementById("user");
const nearbyEl = document.getElementById("nearby");
const messagesEl = document.getElementById("messages");
const chatSection = document.getElementById("chatSection");
const nearSection = document.getElementById("nearSection");
const chatTitle = document.getElementById("chatTitle");
const inputBar = document.getElementById("inputBar");
const inputEl = document.getElementById("messageInput");
const sendBtn = document.getElementById("sendBtn");

let currentUser, username, chatId;

function km(a,b,c,d){
  const R=6371,dl=(c-a)*Math.PI/180,do_=(d-b)*Math.PI/180;
  return R*2*Math.atan2(Math.sqrt(
    Math.sin(dl/2)**2 +
    Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(do_/2)**2
  ), Math.sqrt(1 - (
    Math.sin(dl/2)**2 +
    Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(do_/2)**2
  )));
}

signInAnonymously(auth);

onAuthStateChanged(auth, user => {
  if (!user) return;
  currentUser = user;

  username = localStorage.getItem("name") || prompt("Your name?");
  localStorage.setItem("name", username);
  userEl.textContent = username;

  navigator.geolocation.watchPosition(async p => {
    const { latitude, longitude } = p.coords;
    statusEl.textContent = "Online âœ”";

    await setDoc(doc(db,"users",user.uid),{
      name: username, lat: latitude, lng: longitude,
      lastSeen: serverTimestamp()
    });

    onSnapshot(collection(db,"users"), snap => {
      nearbyEl.innerHTML="";
      snap.forEach(d=>{
        if(d.id===user.uid) return;
        const u=d.data();
        if(km(latitude,longitude,u.lat,u.lng)<=5){
          const li=document.createElement("li");
          li.innerHTML=`<strong>${u.name}</strong><br><span class="small">Tap to like</span>`;
          li.onclick=()=>likeUser(d.id,u.name);
          nearbyEl.appendChild(li);
        }
      });
    });
  });
});

async function likeUser(targetUid, name){
  const likeId = `${currentUser.uid}_${targetUid}`;
  const reverseLike = `${targetUid}_${currentUser.uid}`;

  await setDoc(doc(db,"likes",likeId),{
    from: currentUser.uid,
    to: targetUid,
    created: serverTimestamp()
  });

  const reverseSnap = await getDoc(doc(db,"likes",reverseLike));
  if(reverseSnap.exists()){
    openChat(currentUser.uid, targetUid, name);
  } else {
    alert("Like sent. Waiting for match ðŸ™‚");
  }
}

function openChat(a,b,name){
  chatId=[a,b].sort().join("_");
  chatTitle.textContent=name;
  chatSection.classList.remove("hidden");
  nearSection.classList.add("hidden");
  inputBar.classList.remove("hidden");

  const q=query(collection(db,"chats",chatId,"messages"),orderBy("created"));
  onSnapshot(q,s=>{
    messagesEl.innerHTML="";
    s.forEach(d=>{
      const m=d.data();
      const div=document.createElement("div");
      div.className="bubble "+(m.uid===currentUser.uid?"me":"them");
      div.textContent=m.text;
      messagesEl.appendChild(div);
      messagesEl.scrollTop=messagesEl.scrollHeight;
    });
  });
}

sendBtn.onclick=async()=>{
  if(!inputEl.value) return;
  await addDoc(collection(db,"chats",chatId,"messages"),{
    uid:currentUser.uid,
    text:inputEl.value,
    created: serverTimestamp()
  });
  inputEl.value="";
};
</script>

</body>
</html>
