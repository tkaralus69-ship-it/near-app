<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>NEAR</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
</head>
<body>

<h1>NEAR</h1>

<p id="status">Initializing...</p>
<p>You are: <strong id="user"></strong></p>

<h2>Nearby users (tap to chat)</h2>
<ul id="nearby"></ul>

<hr />

<h2 id="chatTitle" style="display:none;"></h2>
<ul id="messages"></ul>

<input id="messageInput" placeholder="Type a message..." style="display:none;" />
<button id="sendBtn" style="display:none;">Send</button>

<br /><br />
<button id="logout">Logout</button>

<script type="module">
  // Firebase SDKs
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
  import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
  import {
    getFirestore,
    doc,
    setDoc,
    collection,
    addDoc,
    onSnapshot,
    serverTimestamp,
    query,
    orderBy
  } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

  // ðŸ”¥ Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyA2ApGkST41s9U53GQIatv4FL8aCPVzeAM",
    authDomain: "near-c7681.firebaseapp.com",
    projectId: "near-c7681",
    storageBucket: "near-c7681.firebasestorage.app",
    messagingSenderId: "316318833624",
    appId: "1:316318833624:web:480beb2c1909e23d1cf0ad"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const statusEl = document.getElementById("status");
  const userEl = document.getElementById("user");
  const nearbyEl = document.getElementById("nearby");
  const messagesEl = document.getElementById("messages");
  const chatTitleEl = document.getElementById("chatTitle");
  const inputEl = document.getElementById("messageInput");
  const sendBtn = document.getElementById("sendBtn");
  const logoutBtn = document.getElementById("logout");

  const ONLINE_WINDOW_MS = 3 * 60 * 1000;
  let currentChatId = null;
  let currentUser = null;
  let username = null;

  function distanceKm(lat1, lon1, lat2, lon2) {
    const R = 6371;
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a =
      Math.sin(dLat / 2) ** 2 +
      Math.cos(lat1 * Math.PI / 180) *
      Math.cos(lat2 * Math.PI / 180) *
      Math.sin(dLon / 2) ** 2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  }

  // ðŸ” Sign in
  signInAnonymously(auth);

  onAuthStateChanged(auth, user => {
    if (!user) return;
    currentUser = user;

    username = localStorage.getItem("near_username");
    if (!username) {
      username = prompt("Choose a username") || "Anonymous";
      localStorage.setItem("near_username", username);
    }

    userEl.textContent = username;

    navigator.geolocation.watchPosition(async pos => {
      const { latitude, longitude } = pos.coords;
      statusEl.textContent = "Location received âœ”";

      await setDoc(doc(db, "users", user.uid), {
        name: username,
        lat: latitude,
        lng: longitude,
        lastSeen: serverTimestamp()
      });

      onSnapshot(collection(db, "users"), snap => {
        nearbyEl.innerHTML = "";
        const now = Date.now();

        snap.forEach(d => {
          if (d.id === user.uid) return;
          const data = d.data();
          if (!data.lat || !data.lastSeen) return;

          if (now - data.lastSeen.toMillis() > ONLINE_WINDOW_MS) return;

          const dist = distanceKm(latitude, longitude, data.lat, data.lng);
          if (dist <= 5) {
            const li = document.createElement("li");
            li.textContent = `${data.name} â€¢ ${dist.toFixed(2)} km`;
            li.style.cursor = "pointer";
            li.onclick = () => openChat(user.uid, d.id, data.name);
            nearbyEl.appendChild(li);
          }
        });

        if (!nearbyEl.children.length) {
          nearbyEl.innerHTML = "<li>No nearby users online</li>";
        }
      });
    });
  });

  function openChat(uid1, uid2, otherName) {
    currentChatId = [uid1, uid2].sort().join("_");
    chatTitleEl.textContent = `Chat with ${otherName}`;
    chatTitleEl.style.display = "block";
    messagesEl.innerHTML = "";
    inputEl.style.display = "block";
    sendBtn.style.display = "block";

    const q = query(
      collection(db, "chats", currentChatId, "messages"),
      orderBy("created")
    );

    onSnapshot(q, snap => {
      messagesEl.innerHTML = "";
      snap.forEach(d => {
        const m = d.data();
        const li = document.createElement("li");
        li.textContent = `${m.name}: ${m.text}`;
        messagesEl.appendChild(li);
      });
    });
  }

  sendBtn.onclick = async () => {
    const text = inputEl.value.trim();
    if (!text || !currentChatId) return;

    await addDoc(collection(db, "chats", currentChatId, "messages"), {
      uid: currentUser.uid,
      name: username,
      text,
      created: serverTimestamp()
    });

    inputEl.value = "";
  };

  logoutBtn.onclick = () => {
    signOut(auth);
    localStorage.clear();
    location.reload();
  };
</script>

</body>
</html>
