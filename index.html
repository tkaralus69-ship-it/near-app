<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Near</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: radial-gradient(circle at top, #121a2f, #05070f 70%);
      color: #fff;
    }
    header {
      padding: 32px 20px 20px;
      text-align: center;
    }
    header h1 {
      margin: 0;
      font-size: 36px;
      font-weight: 700;
    }
    header p {
      margin: 6px 0 0;
      color: #9aa3c7;
    }
    #count {
      margin-top: 14px;
      font-size: 18px;
      opacity: 0.9;
    }
    #list {
      padding: 10px 16px 120px;
      max-width: 520px;
      margin: 0 auto;
    }
    .card {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 16px;
      margin-bottom: 14px;
      background: rgba(255,255,255,0.06);
      border-radius: 18px;
      backdrop-filter: blur(10px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
      transition: opacity 0.4s ease;
    }
    .avatar {
      width: 54px;
      height: 54px;
      border-radius: 50%;
      background: linear-gradient(135deg, #2d3b6a, #1b2445);
      flex-shrink: 0;
    }
    .info {
      display: flex;
      flex-direction: column;
    }
    .name {
      font-size: 18px;
      font-weight: 600;
    }
    .distance {
      font-size: 14px;
      color: #b6bfdc;
      margin-top: 4px;
    }
    footer {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      padding: 16px;
      background: linear-gradient(to top, rgba(5,7,15,0.95), rgba(5,7,15,0.6));
    }
    button {
      width: 100%;
      max-width: 520px;
      margin: 0 auto;
      display: block;
      padding: 16px;
      font-size: 18px;
      border-radius: 14px;
      border: none;
      color: #fff;
      background: linear-gradient(135deg, #1b8edc, #1769aa);
    }
    .tagline {
      text-align: center;
      margin-top: 10px;
      font-size: 13px;
      color: #8e97b7;
    }
  </style>
</head>
<body>

<header>
  <h1>Near</h1>
  <p>Real people. Near you.</p>
  <div id="count">Loading…</div>
</header>

<div id="list"></div>

<footer>
  <button>Say hello</button>
  <div class="tagline">People come and go • Choose with intention</div>
</footer>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
  import { getFirestore, doc, setDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT.firebaseapp.com",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_PROJECT.appspot.com",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const listEl = document.getElementById("list");
  const countEl = document.getElementById("count");

  let myUid = null;
  let myLat = null;
  let myLng = null;

  const ACTIVE_WINDOW_MS = 45_000; // presence window
  const rendered = new Map(); // uid -> element

  function distanceKm(lat1, lon1, lat2, lon2) {
    const R = 6371;
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a =
      Math.sin(dLat / 2) * Math.sin(dLat / 2) +
      Math.cos(lat1 * Math.PI / 180) *
      Math.cos(lat2 * Math.PI / 180) *
      Math.sin(dLon / 2) * Math.sin(dLon / 2);
    return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)));
  }

  signInAnonymously(auth).then(cred => {
    myUid = cred.user.uid;
    startLocation();
    listenUsers();
  });

  function startLocation() {
    navigator.geolocation.watchPosition(pos => {
      myLat = pos.coords.latitude;
      myLng = pos.coords.longitude;

      setDoc(doc(db, "users", myUid), {
        lat: myLat,
        lng: myLng,
        updatedAt: Date.now(),
        name: "You",
        age: null
      }, { merge: true });
    }, err => {
      console.error("Location error", err);
    }, {
      enableHighAccuracy: true,
      maximumAge: 5000,
      timeout: 10000
    });
  }

  function listenUsers() {
    onSnapshot(collection(db, "users"), snap => {
      const now = Date.now();
      let visibleCount = 0;

      snap.forEach(docSnap => {
        const uid = docSnap.id;
        if (uid === myUid) return;

        const data = docSnap.data();
        if (!data.lat || !data.lng || !data.updatedAt) return;
        if (now - data.updatedAt > ACTIVE_WINDOW_MS) {
          removeUser(uid);
          return;
        }
        if (myLat == null) return;

        const km = distanceKm(myLat, myLng, data.lat, data.lng);
        if (km > 5) {
          removeUser(uid);
          return;
        }

        visibleCount++;
        upsertUser(uid, data, km);
      });

      countEl.textContent = visibleCount === 0
        ? "No one near you right now"
        : `${visibleCount} people near you right now`;
    });
  }

  function upsertUser(uid, data, km) {
    const meters = Math.round(km * 1000);
    let card = rendered.get(uid);

    if (!card) {
      card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <div class="avatar"></div>
        <div class="info">
          <div class="name"></div>
          <div class="distance"></div>
        </div>
      `;
      listEl.appendChild(card);
      rendered.set(uid, card);
    }

    card.querySelector(".name").textContent =
      `${data.name || "Someone"}${data.age ? ", " + data.age : ""}`;
    card.querySelector(".distance").textContent =
      `${meters}m away`;
    card.style.opacity = "1";
  }

  function removeUser(uid) {
    const el = rendered.get(uid);
    if (!el) return;
    el.style.opacity = "0";
    setTimeout(() => {
      el.remove();
      rendered.delete(uid);
    }, 400);
  }
</script>

</body>
</html>
