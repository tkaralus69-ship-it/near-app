<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>NEAR</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
body {
  margin:0;
  font-family:system-ui,sans-serif;
  background:#0f172a;
  color:#e5e7eb;
}
header {
  padding:16px;
  text-align:center;
  font-weight:bold;
  background:#020617;
}
.container { padding:16px; }
.card {
  background:#020617;
  border-radius:16px;
  padding:14px;
  margin-bottom:12px;
}
ul { list-style:none; padding:0; margin:0; }
li {
  background:#020617;
  padding:14px;
  border-radius:14px;
  margin-bottom:8px;
}
.nearby-user {
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
}
button {
  background:#2563eb;
  border:none;
  color:white;
  padding:10px 14px;
  border-radius:999px;
  font-weight:bold;
}
.hidden { display:none; }

/* Chat */
.chat {
  height:calc(100vh - 300px);
  overflow-y:auto;
}
.bubble {
  padding:10px 14px;
  margin-bottom:8px;
  max-width:75%;
  border-radius:16px;
}
.me { background:#2563eb; margin-left:auto; }
.them { background:#1e293b; }

.input-bar {
  position:fixed;
  bottom:0;
  left:0;
  right:0;
  display:flex;
  gap:8px;
  padding:12px;
  background:#020617;
}
input {
  flex:1;
  padding:12px;
  border-radius:999px;
  border:none;
}

/* Match */
#matchOverlay {
  position:fixed;
  inset:0;
  background:radial-gradient(circle at top,#2563eb,#020617 60%);
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  z-index:999;
}
#matchOverlay h1 { font-size:42px; }
#typing { font-size:13px; opacity:.7; }

/* Vibes */
.vibes { display:flex; gap:6px; }
.vibe-btn {
  background:#1e293b;
  padding:6px 10px;
  border-radius:999px;
  font-size:13px;
}

/* Safety */
.safety {
  font-size:12px;
  background:#1e293b;
  margin-left:8px;
}
</style>
</head>

<body>
<header>NEAR</header>

<div class="container">

  <div class="card">
    <div id="status">Initializingâ€¦</div>
    <div>You are <strong id="user"></strong></div>
  </div>

  <div id="nearSection" class="card">
    <h3>Nearby</h3>
    <ul id="nearby"></ul>
  </div>

  <div id="chatSection" class="hidden card">
    <h3>
      <span id="chatTitle"></span>
      <button id="safetyBtn" class="safety">â‹¯ Safety</button>
    </h3>
    <div id="typing"></div>
    <div id="messages" class="chat"></div>
  </div>

</div>

<div id="inputBar" class="input-bar hidden">
  <input id="msg" placeholder="Messageâ€¦" />
  <button id="send">Send</button>
</div>

<div id="matchOverlay" class="hidden">
  <h1>ðŸ’¥ MATCH</h1>
  <p id="matchName"></p>
  <button id="startChat">Start Chat</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import {
  getFirestore, doc, setDoc, getDoc,
  collection, addDoc, onSnapshot,
  serverTimestamp, query, orderBy
} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

/* Firebase */
const app = initializeApp({
  apiKey:"AIzaSyA2ApGkST41s9U53GQIatv4FL8aCPVzeAM",
  authDomain:"near-c7681.firebaseapp.com",
  projectId:"near-c7681",
  appId:"1:316318833624:web:480beb2c1909e23d1cf0ad"
});
const auth = getAuth(app);
const db = getFirestore(app);

/* UI refs */
const statusEl = document.getElementById("status");
const userEl = document.getElementById("user");
const nearbyEl = document.getElementById("nearby");
const chatSection = document.getElementById("chatSection");
const nearSection = document.getElementById("nearSection");
const messagesEl = document.getElementById("messages");
const chatTitle = document.getElementById("chatTitle");
const typingEl = document.getElementById("typing");
const inputBar = document.getElementById("inputBar");
const msgEl = document.getElementById("msg");
const matchOverlay = document.getElementById("matchOverlay");
const matchNameEl = document.getElementById("matchName");
const startChatBtn = document.getElementById("startChat");
const safetyBtn = document.getElementById("safetyBtn");

let me, myName, chatId, activeChatUid;
let typingTimer;

/* Distance */
function km(a,b,c,d){
  const R=6371;
  const dLat=(c-a)*Math.PI/180;
  const dLon=(d-b)*Math.PI/180;
  const x=Math.sin(dLat/2)**2+
    Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
}

/* Auth */
signInAnonymously(auth);
onAuthStateChanged(auth,u=>{
  if(!u) return;
  me=u;
  myName=localStorage.getItem("name")||
    "User-"+Math.random().toString(36).slice(2,6);
  localStorage.setItem("name",myName);
  userEl.textContent=myName;

  navigator.geolocation.watchPosition(async p=>{
    const {latitude,longitude}=p.coords;
    statusEl.textContent="Online âœ”";

    await setDoc(doc(db,"users",me.uid),{
      name:myName,lat:latitude,lng:longitude,lastSeen:serverTimestamp()
    });

    onSnapshot(collection(db,"users"),snap=>{
      nearbyEl.innerHTML="";
      snap.forEach(d=>{
        if(d.id===me.uid) return;
        const u=d.data();
        if(km(latitude,longitude,u.lat,u.lng)>5) return;

        const li=document.createElement("li");
        li.className="nearby-user";
        li.innerHTML=`<strong>${u.name}</strong>`;
        const vibes=document.createElement("div");
        vibes.className="vibes";
        ["ðŸ’™","ðŸ˜‚","âœ¨","ðŸŒ¿"].forEach((e,i)=>{
          const b=document.createElement("button");
          b.className="vibe-btn";
          b.textContent=e;
          b.onclick=()=>sendVibe(d.id,u.name);
          vibes.appendChild(b);
        });
        li.appendChild(vibes);
        nearbyEl.appendChild(li);
      });
    });
  });
});

/* Vibes */
async function sendVibe(uid,name){
  await setDoc(doc(db,"vibes",me.uid+"_"+uid),{
    from:me.uid,to:uid,created:serverTimestamp()
  });
  const rev=await getDoc(doc(db,"vibes",uid+"_"+me.uid));
  if(rev.exists()){
    matchNameEl.textContent=`You and ${name}`;
    matchOverlay.classList.remove("hidden");
    activeChatUid=uid;
  }
}

startChatBtn.onclick=()=>{
  matchOverlay.classList.add("hidden");
  openChat(me.uid,activeChatUid);
};

/* Chat */
function openChat(a,b){
  chatId=[a,b].sort().join("_");
  activeChatUid=b;
  chatTitle.textContent="Chat";
  nearSection.classList.add("hidden");
  chatSection.classList.remove("hidden");
  inputBar.classList.remove("hidden");

  onSnapshot(query(
    collection(db,"chats",chatId,"messages"),
    orderBy("created")
  ),snap=>{
    messagesEl.innerHTML="";
    snap.forEach(d=>{
      const m=d.data();
      const div=document.createElement("div");
      div.className="bubble "+(m.uid===me.uid?"me":"them");
      div.textContent=m.text;

      if(m.uid!==me.uid && !m.readBy?.[me.uid]){
        setDoc(doc(db,"chats",chatId,"messages",d.id),
          {readBy:{[me.uid]:true}},{merge:true});
      }

      if(m.uid===me.uid){
        const r=document.createElement("div");
        r.style.fontSize="11px";
        r.style.opacity=".6";
        r.textContent=m.readBy?"Read":"Delivered";
        div.appendChild(r);
      }

      messagesEl.appendChild(div);
    });
    messagesEl.scrollTop=messagesEl.scrollHeight;
  });

  onSnapshot(doc(db,"chats",chatId),snap=>{
    const t=snap.data()?.typing;
    const other=Object.keys(t||{}).find(id=>id!==me.uid&&t[id]);
    typingEl.textContent=other?"Typingâ€¦":"";
  });
}

/* Typing */
msgEl.oninput=()=>{
  if(!chatId) return;
  setDoc(doc(db,"chats",chatId),{typing:{[me.uid]:true}},{merge:true});
  clearTimeout(typingTimer);
  typingTimer=setTimeout(()=>{
    setDoc(doc(db,"chats",chatId),{typing:{[me.uid]:false}},{merge:true});
  },1200);
};

/* Send */
send.onclick=async()=>{
  if(!msgEl.value) return;
  await addDoc(collection(db,"chats",chatId,"messages"),{
    uid:me.uid,text:msgEl.value,created:serverTimestamp()
  });
  msgEl.value="";
};

/* Safety */
safetyBtn.onclick=async()=>{
  const c=prompt("1 = Block\n2 = Report\n3 = Cancel");
  if(c==="1"){
    await setDoc(doc(db,"blocks",me.uid+"_"+activeChatUid),
      {blocker:me.uid,blocked:activeChatUid,created:serverTimestamp()});
    alert("User blocked.");
    location.reload();
  }
  if(c==="2"){
    const r=prompt("Optional reason:");
    await setDoc(doc(db,"reports",me.uid+"_"+activeChatUid),
      {reporter:me.uid,reported:activeChatUid,reason:r||"",chatId,created:serverTimestamp()});
    alert("Thanks. Weâ€™ll review it.");
  }
};
</script>
</body>
</html>
