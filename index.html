<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Near</title>

  <style>
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: linear-gradient(#0f172a, #020617);
      color: white;
    }
    header {
      padding: 20px;
      font-size: 28px;
      font-weight: bold;
    }
    .sub {
      opacity: 0.7;
      font-size: 14px;
    }
    .status {
      margin: 10px 20px;
      padding: 12px;
      background: #38bdf8;
      color: #020617;
      border-radius: 8px;
      text-align: center;
      font-weight: 600;
    }
    .list {
      padding: 10px 20px;
    }
    .card {
      background: rgba(255,255,255,0.06);
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 12px;
    }
    .distance {
      opacity: 0.7;
      font-size: 14px;
    }
  </style>
</head>

<body>

<header>
  üìç Near
  <div class="sub">Find people close to you right now</div>
</header>

<div id="status" class="status">Getting location‚Ä¶</div>
<div id="list" class="list"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
  import { getFirestore, doc, setDoc, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyA2ApGkST41s9U53GQIatv4FL8aCPVzeAM",
    authDomain: "near-c7681.firebaseapp.com",
    projectId: "near-c7681",
    storageBucket: "near-c7681.firebasestorage.app",
    messagingSenderId: "316318833624",
    appId: "1:316318833624:web:480beb2c1909e23d1cf0ad"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const statusEl = document.getElementById("status");
  const listEl = document.getElementById("list");

  let myLat = null;
  let myLng = null;
  let myUid = null;

  function distanceKm(lat1, lon1, lat2, lon2) {
    const R = 6371;
    const dLat = (lat2-lat1) * Math.PI/180;
    const dLon = (lon2-lon1) * Math.PI/180;
    const a =
      Math.sin(dLat/2)**2 +
      Math.cos(lat1*Math.PI/180) *
      Math.cos(lat2*Math.PI/180) *
      Math.sin(dLon/2)**2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  }

  signInAnonymously(auth).then(({ user }) => {
    myUid = user.uid;

    navigator.geolocation.watchPosition(async pos => {
      myLat = pos.coords.latitude;
      myLng = pos.coords.longitude;

      statusEl.textContent = "Location enabled";

      await setDoc(doc(db, "users", myUid), {
        lat: myLat,
        lng: myLng,
        lastActive: Date.now()
      });
    });
  });

  onSnapshot(collection(db, "users"), snap => {
    listEl.innerHTML = "";

    snap.forEach(docSnap => {
      if (docSnap.id === myUid) return;

      const u = docSnap.data();
      if (!u.lat || !u.lng || myLat === null) return;

      const km = distanceKm(myLat, myLng, u.lat, u.lng);
      if (km > 5) return;

      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <div><strong>Someone nearby</strong></div>
        <div class="distance">${km.toFixed(2)} km away</div>
      `;
      listEl.appendChild(card);
    });
  });
</script>

</body>
</html>
